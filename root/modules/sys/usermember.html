<div>
    <form class="module-filterform" style="margin: 0 0 0 0;">
        <table class="datagrid-cell-rownumber" style="margin-left: 20px;">
            <tr>
                <td>账 号</td>
                <td><input class="easyui-validatebox" name="bean.account" style="width: 155px;"/></td>
                <td><a href="javascript:void(0);" class="easyui-linkbutton module-filter-button" data-options="iconCls:'ext-icon-zoom',plain:true">查询</a></td>
            </tr>
        </table>
    </form>
</div>
<table class="module-table" />
<div class="module-dialog" style="display:none; overflow: hidden">
    <form class="module-form">
        <table class="datagrid-cell-rownumber" style="margin-left: 40px;">
            <tr style="height: 20px;">
                <th></th>
                <td><input name="userid" style="display:none;" /></td>
            </tr>
            <tr>
                <th>用户账号<font color="red">*</font></th>
                <td><input name="account" class="easyui-validatebox" data-options="required:true" /></td>
            </tr>
            <tr class="module-form-field-password">
                <th>用户密码<font color="red">*</font></th>
                <td><input name="password" class="easyui-validatebox" data-options="required:false" /></td>
            </tr>
            <tr>
                <th>用户名称<font color="red">*</font></th>
                <td><input name="chname" class="easyui-validatebox" data-options="required:true" /></td>
            </tr>
            <tr>
                <th style="height: 5px;">--------</th>
                <td>---------------------------</td>
            </tr>
            <tr>
                <th>手 机</th>
                <td><input name="mobile" class="easyui-validatebox" data-options="required:false" /></td>
            </tr>
            <tr>
                <th>邮 箱</th>
                <td><input name="email" class="easyui-validatebox" data-options="required:false" /></td>
            </tr>
            <tr>
                <th>备注说明</th>
                <td><textarea class="easyui-validatebox" name="remark" style="height:40px;" ></textarea></td>
            </tr>
        </table>
    </form>
</div>

<div class="module-dialog-auth" style="display:none;">
    <form class="module-form-auth">
        <table class="module-table-auth" />
    </form>
</div>
<script type="text/javascript">
    (function() {
        //加载表格
        var moduleTab = $('#moduleTab');
        var dataTable = moduleTab.find(".module-table").first();
        var winDialog = moduleTab.find(".module-dialog").first();
        var windialogauth = moduleTab.find(".module-dialog-auth").first();
        var filterform = moduleTab.find(".module-filterform").first();
        var passwordtr = moduleTab.find(".module-form-field-password").first();
        var formauth = moduleTab.find(".module-form-auth").first();
        var authTable = moduleTab.find(".module-table-auth").first();
        var form = moduleTab.find(".module-form").first();
        var createQueryParams = function() {//查询条件
            return  {bean: filterform.serializeJsonString("bean")};
        };
        moduleTab.find(".module-filter-button").first().click(function() {
            dataTable.datagrid('load', createQueryParams());
        });
        var rolearray = [];
        var allroledata = null;
        $.ajax({
            async: false,
            cache: false,
            dataType: "json",
            url: '/pipes/role/query',
            success: function(sheetdata) {
                var rows = sheetdata.rows || [];
                rolearray = rows;
                allroledata = {};
                for (var i = 0; i < rows.length; i++) {
                    allroledata["" + rows[i].roleid] = rows[i].rolename;
                }
            }
        });
        if (!allroledata) {
            alert('获取角色信息失败');
            return;
        }
        dataTable.datagrid({
            collapsible: true,
            title: '',
            iconCls: '',
            url: '/pipes/user/query',
            pageSize : 50,
            columns: [[
                    {field: 'ck', checkbox: true, width: 30, align: 'center'},
                    {field: 'userid', title: '用户ID', width: 40, align: 'center'},
                    {field: 'account', title: '用户账号', width: 80, align: 'left'},
                    {field: 'chname', title: '用户名称', width: 100, align: 'left'},
                    {field: 'status', title: '状 态', width: 40, align: 'center',
                        formatter: function(value, row, i) {
                            if (value === 10) return "正常";
                            if (value === 20) return "<font color=red>禁用</font>";
                            return "<font color=#FF00FF>未知</font>";
                        }},
                    {field: 'roleids', title: '角色', width: 80, align: 'center',
                        formatter: function(value, row, i) {
                            if (!value || !value.length) return "";
                            var a = [];
                            for (var i = 0; i < value.length; i++) {
                                var n = allroledata["" + value[i]];
                                a.push(n ? n : value[i]);
                            }
                            return a.join("  ");
                        }},
                    {field: 'createtime', title: '创建时间', width: 80, align: 'center', formatter: Platform.DateFormatter},
                    {field: 'remark', title: '描述', width: 200, align: 'left'}
                ]],
            queryParams: createQueryParams(),
            toolbar: [{
                    text: '新增用户',
                    iconCls: 'icon-add',
                    handler: function() {
                        form.form('reset');
                        passwordtr.show();
                        var dialog = winDialog.show().dialog({
                            title: '新增用户',
                            iconCls: 'ext-icon-user',
                            width: 400,
                            height: 350,
                            shadow: true,
                            modal: true,
                            buttons: [{
                                    text: '新 增',
                                    iconCls: 'ext-icon-new',
                                    handler: function() {
                                        if (!form.form('validate')) return;
                                        var json = form.serializeJson();
                                        if (!json['userid']) delete json.userid;
                                        if (!json['sysid']) delete json.sysid;
                                        if (!json.password) {
                                            alert("密码不能为空");
                                            return;
                                        }
                                        if (json.type === system_adminpid) {
                                            alert("不允许创建管理员账号");
                                            return;
                                        }
                                        $.ajax({
                                            async: false,
                                            cache: false,
                                            dataType: "json",
                                            data: {
                                                "data": $.objectToString(json),
                                            },
                                            url: '/pipes/user/create',
                                            error: function() {//请求失败处理函数
                                                alert('请求失败');
                                            }, success: function(data) {
                                                dataTable.datagrid('reload', createQueryParams());
                                                dialog.dialog("close");
                                            }
                                        });
                                    }
                                }]

                        });
                    }
                }, {
                    text: '修改用户',
                    iconCls: 'icon-edit',
                    handler: function() {
                        var row = dataTable.datagrid('getSelected');
                        if (!row) return;
                        form.form('load', row);
                        passwordtr.hide();
                        var dialog = winDialog.show().dialog({
                            title: '修改用户',
                            iconCls: 'ext-icon-user',
                            width: 400,
                            height: 350,
                            shadow: true,
                            modal: true,
                            buttons: [{
                                    text: '修 改',
                                    iconCls: 'ext-icon-edit',
                                    handler: function() {
                                        if (!form.form('validate')) return;
                                        var json = form.serializeJson();
                                        if (json.type === system_adminpid) {
                                            alert("不允许修改管理员账号");
                                            return;
                                        }
                                        $.ajax({
                                            async: false,
                                            cache: false,
                                            dataType: "json",
                                            data: {
                                                "data": $.objectToString(json)
                                            },
                                            url: '/pipes/user/update',
                                            error: function() {//请求失败处理函数
                                                alert('请求失败');
                                            }, success: function(data) {
                                                dataTable.datagrid('reload', createQueryParams());
                                                dialog.dialog("close");
                                            }
                                        });
                                    }
                                }]

                        });
                    }
                }, {
                    text: '修改角色',
                    iconCls: 'icon-edit',
                    handler: function() {
                        var userrow = dataTable.datagrid('getSelected');
                        if (!userrow) return;
                        if (userrow.type === system_adminpid) {
                            alert("超级管理员身份无需配置角色!");
                            return;
                        }
                        var myroleids = userrow.roleids;

                        authTable.datagrid({
                            checkOnSelect: false,
                            selectOnCheck: false,
                            pagination: false,
                            title: '',
                            iconCls: '',
                            columns: [[
                                    {field: 'roleid', width: 30, align: 'center',
                                        formatter: function(value, rec, rowIndex) {
                                            return '<input type="checkbox" name="' + value + '" value="' + value + '" ' + ($.inArray(value, myroleids) >= 0 ? 'checked' : '') + '>';
                                        }
                                    },
                                    {field: 'rolename', title: '<b>角色名称</b>', width: 200, align: 'center'}
                                ]],
                            data: rolearray
                        });
                        var dialog = windialogauth.show().dialog({
                            title: '修改角色',
                            iconCls: 'ext-icon-user',
                            width: 300,
                            height: 250,
                            shadow: true,
                            modal: true,
                            buttons: [{
                                    text: '修 改',
                                    iconCls: 'ext-icon-edit',
                                    handler: function() {

                                        $.ajax({
                                            async: false,
                                            cache: false,
                                            dataType: "json",
                                            data: {
                                                "bean": "{'userid':" + userrow.userid + ",'sysids':[" + userrow.sysid + "]}"
                                            },
                                            url: '/pipes/role/qryuserole',
                                            error: function() {
                                                alert('请求用户角色失败');
                                            }, success: function(usertorolesheet) {
                                                var editobj = formauth.serializeJson();
                                                var delseqids = [];
                                                if (usertorolesheet.rows) {
                                                    var utrrows = usertorolesheet.rows;
                                                    for (var i = 0; i < utrrows.length; i++) {
                                                        if (editobj["" + utrrows[i].roleid]) {
                                                            delete editobj["" + utrrows[i].roleid];
                                                        } else {
                                                            delseqids.push(utrrows[i].seqid);
                                                        }
                                                    }
                                                }
                                                $.unique(delseqids);
                                                var newutrs = [];
                                                for (var p in editobj) {
                                                    newutrs.push({
                                                        sysid: userrow.sysid,
                                                        userid: userrow.userid,
                                                        roleid: p
                                                    });
                                                }
                                                $.ajax({
                                                    async: false,
                                                    cache: false,
                                                    dataType: "json",
                                                    data: {
                                                        "delseqids": "[" + delseqids.join(",") + "]",
                                                        "data": $.objectToString(newutrs)
                                                    },
                                                    url: '/pipes/role/upduserole',
                                                    error: function() {//请求失败处理函数
                                                        alert('修改角色请求失败');
                                                    }, success: function(data) {
                                                        dataTable.datagrid('reload', createQueryParams());
                                                        dialog.dialog("close");
                                                    }
                                                });
                                            }
                                        });
                                    }
                                }]

                        });
                    }
                }],
            onLoadError: function() {
                //alert('数据加载失败!');
            },
            onLoadSuccess: function() {
                var value = dataTable.datagrid('getData')['errorMsg'];
                if (value) alert("错误消息:" + value);
            }
        });
    })();
</script>